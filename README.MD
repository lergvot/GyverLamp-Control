# UDP управление GyverLamp (прошивка gunner47 v.2)

Документация по UDP командам для управления светодиодной лампой GyverLamp.

## Ссылки

- [Страница оригинального проекта](https://alexgyver.ru/gyverlamp/)
- [Репозиторий прошивки gunner47](https://github.com/SottNick/GyverLamp)

## UDP-интерфейс «GyverLamp»

> ⚠️ **Внимание**: текст сгенерирован на основе анализа parsing.ino, возможны неточности

Лампа принимает команды через UDP (порт `8888`, `ESP_UDP_PORT`).
Все сообщения отправляются в виде ASCII/UTF‑8-строк. Команды и аргументы разделяются пробелом.

### ❗️ Важные замечания

- Ответ всегда возвращается на порт отправителя (`Udp.remotePort()`)
- Даже если установлен `wait_response=False`, лампа отправит ответ

Пример использования смотрите в [example.py](example.py)

### 1. Включение/выключение

| Команда | Аргументы | Описание | Ответ |
|:--------|:----------|:---------|:------|
| `P_ON` | - | Включить лампу | `CURR …` |
| `P_OFF` | - | Выключить лампу | `CURR …` |

### 2. Получение состояния

| Команда | Аргументы | Описание | Ответ |
|:--------|:----------|:---------|:------|
| `GET` | `0` | Получить время | `TIME HH:MM:SS` |
| `GET` | `1` | Получить статус | См. ниже |

Формат ответа на `GET 1`:

```
CURR <mode> <brightness> <speed> <scale> <on_flag> <esp_mode> <ntp_enabled> <timer_running> <button_enabled> <HH:MM:SS>
```

### 3. Управление эффектом

| Команда | Аргументы | Описание | Ответ |
|:--------|:----------|:---------|:------|
| `EFF` | `<номер>` (0‑86) | Переключить на эффект | `CURR …` |
| `BRI` | `<яркость 1‑255>` | Установить яркость | `CURR …` |
| `SPD` | `<скорость>` | Установить скорость | `CURR …` |
| `SCA` | `<масштаб>` | Установить масштаб | `CURR …` |

> Если нужно изменить несколько параметров, отправьте их по отдельности.

### 4. Управление будильниками

> Будильники обозначаются как `ALM_1…7`. Каждый из них хранит два параметра: *состояние* (ON/OFF) и время (`HH:MM`).  

| Команда | Аргументы | Описание | Ответ |
|:--------|:----------|:---------|:------|
| `ALM_SET` | `<номер> ON` / `OFF` / `HH:MM` | Установить состояние или время для будильника | `ALMS …` |
| `ALM_GET` | - | Получить состояние/время всех будильников | `ALMS …` |

Примеры:

```
ALM_SET 3 ON          # включаем будильник 3
ALM_SET 5 07:30       # ставим время для будильника 5
```

### 5. Рассвет (дневной режим)

| Команда | Аргументы | Описание | Ответ |
|:--------|:----------|:---------|:------|
| `DAWN` | `<номер>` (1‑9) | Выбрать режим рассвета (`dawnMode`) | `CURR …` |

> Внутренний список смещения: 5 мин, 10 мин, … 60 мин.

### 6. Дискавери

| Команда | Аргументы | Описание | Ответ |
|:--------|:----------|:---------|:------|
| `DISCOVER` | - | Запросить IP‑адрес и порт лампы | `IP <ip>:<port>[:<name>]` |

### 7. Таймер выключения

| Команда | Аргументы | Описание | Ответ |
|:--------|:----------|:---------|:------|
| `TMR_SET` | `<hh:mm>` (или `<minutes>` в формате HH:MM) | Установить таймер выключения на заданное время | `TMR …` |
| `TMR_GET` | - | Получить статус таймера | `TMR …` |

Формат ответа:

```
TMR <running_flag> <option> <remaining_seconds>
```

### 8. Избранные эффекты

| Команда | Аргументы | Описание | Ответ |
|:--------|:----------|:---------|:------|
| `FAV_SET` | `<data>` (спецификация избранных эффектов) | Установить список «избранных» | `FAV …` |
| `FAV_GET` | - | Получить список избранных | `FAV …` |

> Внутренний формат списка: пока не раскрыт в коде, но обычно это последовательность номеров эффектов через запятую.

### 9. OTA‑обновление прошивки

| Команда | Аргументы | Описание | Ответ |
|:--------|:----------|:---------|:------|
| `OTA` | - | Запросить обновление (два запроса подряд в коде) | `CURR …` + переход на режим «Матрица» для индикации |

### 10. Управление кнопкой

| Команда | Аргументы | Описание | Ответ |
|:--------|:----------|:---------|:------|
| `BTN` | `ON` / `OFF` | Включить/выключить кнопку (если отключена – не будет реагировать) | `CURR …` |

### 11. Общая яркость всех эффектов

| Команда | Аргументы | Описание | Ответ |
|:--------|:----------|:---------|:------|
| `GBR` | `<яркость 1‑255>` | Установить яркость для *всех* эффектов без записи в EEPROM | `CURR …` |

### 12. Случайные настройки

| Команда | Аргументы | Описание | Ответ |
|:--------|:----------|:---------|:------|
| `RND_0` | - | Вернуть настройки по умолчанию для текущего эффекта | `CURR …` |
| `RND_1` | - | Случайный набор настроек для текущего эффекта | (нет ответа) |
| `RND_Z` | - | Вернуть настройки по умолчанию всем эффектам | `CURR …` |
| `RND_ON` / `RND_OFF` | - | Включить/выключить случайные настройки в режиме «Цикл» | `CURR …` |

### 13. Бегущая строка (текст)

| Команда | Аргументы | Описание | Ответ |
|:--------|:----------|:---------|:------|
| `TXT` | `<text>` | Показать бегущую строку на матрице | `CURR …` |

> Специальные подкоманды (доступны, если включена директива `USE_SECRET_COMMANDS`):  
>
> - `TXT-time=HH:MM D` – установить время вручную.  
> - `TXT-esp_mode=0/1` – сменить режим работы ESP.  
> - `TXT-reset=wifi/effects/alarm/dawn/timer/sleep` – сброс различных настроек.

### 14. Рисование (старый интерфейс)

| Команда | Аргументы | Описание | Ответ |
|:--------|:----------|:---------|:------|
| `DRW` | `x;y;color` | Нарисовать точку на матрице (`color` – RGB, разделённые точкой с запятой) | (нет ответа) |
| `CLR` | - | Очистить всю матрицу | (нет ответа) |
| `COL` | `R;G;B` | Установить цвет для последующих рисований | (нет ответа) |
| `DRAWO` | `ON/OFF` | Включить/выключить режим рисования | (нет ответа) |

> Эти команды не используются в мобильном приложении, но можно подключить вручную через любой UDP‑клиент.

### 15. Сброс Wi‑Fi настроек

| Команда | Аргументы | Описание | Ответ |
|:--------|:----------|:---------|:------|
| `RESET` | - | Сбросить сохранённые SSID/пароль (приложение будет вынуждено заново настроиться) | (нет ответа, но лампа перезагружается в режим AP) |

## Как формировать запросы

```python
# Пример: переключаем на эффект 42 и ставим яркость 150
sock.sendto(b'EFF 42', (LAMPA_IP, LAMPA_PORT))
sock.sendto(b'BRI 150', (LAMPA_IP, LAMPA_PORT))

# Запрос текущего состояния
resp = sock.recvfrom(512)[0].decode()
print(resp)   # CURR 42 150 200 50 1 1 0 1 0 12:34:56

# Ставим будильник №3 на 07:30
sock.sendto(b'ALM_SET 3 07:30', (LAMPA_IP, LAMPA_PORT))
```

> **Совет** – всегда ставьте `wait_response=True`, иначе вы не увидите подтверждения от лампы.

## Ответы и их разбор

| Тип ответа | Формат | Что можно извлечь |
|------------|--------|-------------------|
| **CURR**  | `CURR <mode> <br> <spd> <scl> <on> <esp> <ntp> <timer> <btn> <HH:MM:SS>` | Полный статус лампы. |
| **TIME**  | `TIME HH:MM:SS` | Текущее время (если запрашивали `GET 0`). |
| **ALMS**  | `ALMS <states...> <times...> <dawnMode+1>` | Состояние/время всех будильников и режим рассвета. |
| **TMR**   | `TMR <running> <option> <remaining_sec>` | Статус таймера выключения. |
| **FAV**   | `FAV …` | Список избранных эффектов (не раскрыт в коде). |
| **LIST1/2/3** | Перечень описаний эффектов (строки вида `<номер>. <название>,<min>...;<...>` ) | Позволяет получить список всех доступных эффектов. |

## Быстрый чек‑лист для отладки

1. **Порт**: 8888 (`ESP_UDP_PORT`).  
2. **IP** лампы – выводится в приложении либо через `DISCOVER`.  
3. **Кодировка**: ASCII/UTF‑8 (не двоичный).  
4. **Ответы приходят на исходный порт** → слушайте его (`sock.settimeout(…)` и `recvfrom`).  
5. **Команды без аргументов**: `P_ON`, `P_OFF`, `DISCOVER`, `RESET`.  
6. **Проверка**: Отправьте `"GET 1"` – если получите строку вида `CURR …`, всё работает.
